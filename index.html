<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KM Fácil - Reembolso e Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .form-input {
            @apply w-full bg-slate-50 border border-slate-200 rounded-lg py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all;
        }
        .btn-primary {
            @apply w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all shadow-md;
        }
        .btn-secondary {
             @apply bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition-all;
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
        .tab-button {
            @apply px-4 py-2 font-semibold text-slate-500 rounded-md transition-colors duration-200;
        }
        .tab-button.active {
            @apply bg-blue-600 text-white shadow-md;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">

        <!-- Header with Logo and Title -->
        <header class="flex items-center gap-4 mb-6">
            <div class="bg-blue-600 p-3 rounded-xl shadow-lg">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.5 5L12 1.5L15.5 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 1.5V13.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 22.5C16.1421 22.5 19.5 19.1421 19.5 15C19.5 10.8579 16.1421 7.5 12 7.5C7.85786 7.5 4.5 10.8579 4.5 15C4.5 19.1421 7.85786 22.5 12 22.5Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 15L14 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-slate-800">KM Fácil</h1>
                <p class="text-slate-500">Seu assistente de reembolso e gestão veicular.</p>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="mb-8 bg-slate-200 p-1.5 rounded-lg flex items-center justify-center space-x-2">
            <button class="tab-button active" data-tab="trips">Deslocamentos</button>
            <button class="tab-button" data-tab="vehicles">Veículos</button>
            <button class="tab-button" data-tab="fueling">Abastecimentos</button>
        </div>

        <!-- Main Content Area -->
        <main>
            <!-- Trips Section -->
            <div id="trips-section" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">Novo Deslocamento</h2>
                        <form id="trip-form" class="space-y-5">
                            <div>
                                <label for="tripVehicle" class="block text-sm font-medium text-slate-600 mb-1">Veículo</label>
                                <select id="tripVehicle" name="tripVehicle" class="form-input" required></select>
                            </div>
                            <div>
                                <label for="reason" class="block text-sm font-medium text-slate-600 mb-1">Motivo</label>
                                <input type="text" id="reason" name="reason" class="form-input" placeholder="Ex: Visita ao cliente XPTO" required>
                            </div>
                            <div>
                                <label for="startKm" class="block text-sm font-medium text-slate-600 mb-1">KM Partida</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="startKm" name="startKm" class="form-input" placeholder="15000" required>
                                    <input type="file" id="startPhotoInput" accept="image/*" capture="environment" class="hidden">
                                    <button type="button" id="startPhotoButton" class="p-3 bg-slate-100 rounded-lg hover:bg-slate-200 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                                    </button>
                                </div>
                                <img id="startPhotoPreview" class="mt-2 rounded-lg hidden w-full h-auto" alt="Pré-visualização da foto de partida">
                            </div>
                            <div>
                                <label for="endKm" class="block text-sm font-medium text-slate-600 mb-1">KM Chegada</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="endKm" name="endKm" class="form-input" placeholder="15120" required>
                                    <input type="file" id="endPhotoInput" accept="image/*" capture="environment" class="hidden">
                                    <button type="button" id="endPhotoButton" class="p-3 bg-slate-100 rounded-lg hover:bg-slate-200 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                                    </button>
                                </div>
                                <img id="endPhotoPreview" class="mt-2 rounded-lg hidden w-full h-auto" alt="Pré-visualização da foto de chegada">
                            </div>
                            <div>
                                <label for="rate" class="block text-sm font-medium text-slate-600 mb-1">Valor por KM (R$)</label>
                                <input type="number" id="rate" name="rate" class="form-input" value="0.75" step="0.01" required>
                            </div>
                            <div id="summary" class="bg-blue-50 border border-blue-200 p-4 rounded-lg text-center hidden">
                                <p class="text-sm text-blue-800">Distância: <span id="totalKm" class="font-bold">0 km</span></p>
                                <p class="text-lg text-blue-900">Reembolso: <span id="totalValue" class="font-bold">R$ 0,00</span></p>
                            </div>
                            <button type="submit" class="btn-primary">Registrar Deslocamento</button>
                            <div id="message-area-trip" class="text-center text-sm mt-2"></div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">Histórico de Deslocamentos</h2>
                            <button id="open-report-modal" class="btn-secondary flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
                                Gerar Relatório
                            </button>
                        </div>
                        <div class="overflow-auto max-h-[60vh]">
                            <table class="w-full text-left">
                                <thead class="sticky top-0 bg-white">
                                    <tr>
                                        <th class="p-3 text-sm font-semibold text-slate-500">Data</th>
                                        <th class="p-3 text-sm font-semibold text-slate-500">Motivo</th>
                                        <th class="p-3 text-sm font-semibold text-slate-500 text-right">KM Total</th>
                                        <th class="p-3 text-sm font-semibold text-slate-500 text-right">Reembolso</th>
                                    </tr>
                                </thead>
                                <tbody id="trip-history" class="divide-y divide-slate-100">
                                <tr id="loading-state-trip">
                                    <td colspan="4" class="p-6 text-center text-slate-500">Carregando...</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vehicles Section -->
            <div id="vehicles-section" class="tab-content hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">Novo Veículo</h2>
                        <form id="vehicle-form" class="space-y-5">
                            <div>
                                <label for="vehicleName" class="block text-sm font-medium text-slate-600 mb-1">Apelido do Veículo</label>
                                <input type="text" id="vehicleName" name="vehicleName" class="form-input" placeholder="Ex: Carro da Empresa" required>
                            </div>
                             <div>
                                <label for="vehiclePlate" class="block text-sm font-medium text-slate-600 mb-1">Placa</label>
                                <input type="text" id="vehiclePlate" name="vehiclePlate" class="form-input" placeholder="ABC-1234" required>
                            </div>
                            <button type="submit" class="btn-primary">Adicionar Veículo</button>
                            <div id="message-area-vehicle" class="text-center text-sm mt-2"></div>
                        </form>
                    </div>
                     <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">Veículos Cadastrados</h2>
                        <div id="vehicle-list" class="space-y-3">
                             <div id="loading-state-vehicle" class="p-6 text-center text-slate-500">Carregando...</div>
                        </div>
                     </div>
                </div>
            </div>

            <!-- Fueling Section -->
            <div id="fueling-section" class="tab-content hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">Novo Abastecimento</h2>
                        <form id="fueling-form" class="space-y-5">
                            <div>
                                <label for="fuelingVehicle" class="block text-sm font-medium text-slate-600 mb-1">Veículo</label>
                                <select id="fuelingVehicle" name="fuelingVehicle" class="form-input" required></select>
                            </div>
                            <div>
                                <label for="fuelingDate" class="block text-sm font-medium text-slate-600 mb-1">Data</label>
                                <input type="date" id="fuelingDate" name="fuelingDate" class="form-input" required>
                            </div>
                            <div>
                                <label for="fuelingOdometer" class="block text-sm font-medium text-slate-600 mb-1">Odômetro (KM)</label>
                                <input type="number" id="fuelingOdometer" name="fuelingOdometer" class="form-input" placeholder="15250" required>
                            </div>
                             <div>
                                <label for="fuelingLiters" class="block text-sm font-medium text-slate-600 mb-1">Litros Abastecidos</label>
                                <input type="number" id="fuelingLiters" name="fuelingLiters" step="0.01" class="form-input" placeholder="40.5" required>
                            </div>
                             <div>
                                <label for="fuelingCost" class="block text-sm font-medium text-slate-600 mb-1">Valor Total (R$)</label>
                                <input type="number" id="fuelingCost" name="fuelingCost" step="0.01" class="form-input" placeholder="220.00" required>
                            </div>
                            <button type="submit" class="btn-primary">Registrar Abastecimento</button>
                             <div id="message-area-fueling" class="text-center text-sm mt-2"></div>
                        </form>
                    </div>
                     <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">Histórico e Consumo</h2>
                        <div id="consumption-summary" class="mb-4"></div>
                        <div class="overflow-auto max-h-[60vh]">
                           <table class="w-full text-left">
                                <thead class="sticky top-0 bg-white">
                                    <tr>
                                        <th class="p-3 text-sm font-semibold text-slate-500">Data</th>
                                        <th class="p-3 text-sm font-semibold text-slate-500">Veículo</th>
                                        <th class="p-3 text-sm font-semibold text-slate-500 text-right">Litros</th>
                                        <th class="p-3 text-sm font-semibold text-slate-500 text-right">Consumo</th>
                                    </tr>
                                </thead>
                                <tbody id="fueling-history" class="divide-y divide-slate-100">
                                   <tr id="loading-state-fueling"><td colspan="4" class="p-6 text-center text-slate-500">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                     </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Report Modal -->
    <div id="report-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Relatório por Período</h3>
                <button id="close-report-modal" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="startDate" class="block text-sm font-medium text-slate-600 mb-1">Data de Início</label>
                    <input type="date" id="startDate" name="startDate" class="form-input">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium text-slate-600 mb-1">Data de Fim</label>
                    <input type="date" id="endDate" name="endDate" class="form-input">
                </div>
            </div>
            <button id="generate-report" class="btn-primary mb-6">Gerar</button>
            
            <div id="report-results" class="space-y-4"></div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, Timestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let vehiclesCache = [];

        // --- DOM Elements ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Trip elements
        const tripForm = document.getElementById('trip-form');
        const startKmInput = document.getElementById('startKm');
        const endKmInput = document.getElementById('endKm');
        const rateInput = document.getElementById('rate');
        const summaryDiv = document.getElementById('summary');
        const totalKmSpan = document.getElementById('totalKm');
        const totalValueSpan = document.getElementById('totalValue');
        const tripHistoryBody = document.getElementById('trip-history');
        const messageAreaTrip = document.getElementById('message-area-trip');
        const loadingStateTrip = document.getElementById('loading-state-trip');
        const startPhotoButton = document.getElementById('startPhotoButton');
        const startPhotoInput = document.getElementById('startPhotoInput');
        const startPhotoPreview = document.getElementById('startPhotoPreview');
        const endPhotoButton = document.getElementById('endPhotoButton');
        const endPhotoInput = document.getElementById('endPhotoInput');
        const endPhotoPreview = document.getElementById('endPhotoPreview');
        
        // Vehicle elements
        const vehicleForm = document.getElementById('vehicle-form');
        const vehicleListDiv = document.getElementById('vehicle-list');
        const tripVehicleSelect = document.getElementById('tripVehicle');
        const fuelingVehicleSelect = document.getElementById('fuelingVehicle');
        const messageAreaVehicle = document.getElementById('message-area-vehicle');
        const loadingStateVehicle = document.getElementById('loading-state-vehicle');

        // Fueling elements
        const fuelingForm = document.getElementById('fueling-form');
        const fuelingHistoryBody = document.getElementById('fueling-history');
        const consumptionSummaryDiv = document.getElementById('consumption-summary');
        const messageAreaFueling = document.getElementById('message-area-fueling');
        const loadingStateFueling = document.getElementById('loading-state-fueling');

        // Modal elements
        const reportModal = document.getElementById('report-modal');
        const openReportModalBtn = document.getElementById('open-report-modal');
        const closeReportModalBtn = document.getElementById('close-report-modal');
        const generateReportBtn = document.getElementById('generate-report');
        const reportResultsDiv = document.getElementById('report-results');
        
        let startPhotoBase64 = null;
        let endPhotoBase64 = null;

        // --- Helper Functions ---
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const formatDate = (timestamp) => timestamp.toDate().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
        const showMessage = (area, text, type = 'success') => {
            area.textContent = text;
            area.className = `text-center text-sm mt-2 ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
            setTimeout(() => { area.textContent = ''; }, 3000);
        };

        // --- Navigation Logic ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                const tab = button.getAttribute('data-tab');
                tabContents.forEach(content => {
                    if (content.id === `${tab}-section`) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
            });
        });

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                loadVehicles();
                loadTrips();
                loadFuelings();
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                }
            }
        });

        // --- Vehicle Logic ---
        const loadVehicles = () => {
            if (!userId) return;
            const vehiclesCollection = collection(db, `/artifacts/${appId}/users/${userId}/vehicles`);
            onSnapshot(query(vehiclesCollection), (snapshot) => {
                loadingStateVehicle.style.display = 'none';
                vehicleListDiv.innerHTML = '';
                tripVehicleSelect.innerHTML = '';
                fuelingVehicleSelect.innerHTML = '';

                vehiclesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (vehiclesCache.length === 0) {
                    vehicleListDiv.innerHTML = `<p class="p-6 text-center text-slate-500">Nenhum veículo cadastrado.</p>`;
                    const defaultOption = '<option disabled selected>Cadastre um veículo primeiro</option>';
                    tripVehicleSelect.innerHTML = defaultOption;
                    fuelingVehicleSelect.innerHTML = defaultOption;
                } else {
                     vehiclesCache.forEach(vehicle => {
                        const vehicleDiv = document.createElement('div');
                        vehicleDiv.className = 'flex justify-between items-center p-3 bg-slate-50 rounded-lg';
                        vehicleDiv.innerHTML = `
                            <div>
                                <p class="font-bold">${vehicle.name}</p>
                                <p class="text-sm text-slate-500">${vehicle.plate}</p>
                            </div>
                        `;
                        vehicleListDiv.appendChild(vehicleDiv);

                        const option = document.createElement('option');
                        option.value = vehicle.id;
                        option.textContent = `${vehicle.name} (${vehicle.plate})`;
                        tripVehicleSelect.appendChild(option.cloneNode(true));
                        fuelingVehicleSelect.appendChild(option);
                    });
                }
            });
        };

        vehicleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!userId) return;
            try {
                const vehiclesCollection = collection(db, `/artifacts/${appId}/users/${userId}/vehicles`);
                await addDoc(vehiclesCollection, {
                    name: vehicleForm.vehicleName.value,
                    plate: vehicleForm.vehiclePlate.value,
                    createdAt: Timestamp.now()
                });
                showMessage(messageAreaVehicle, "Veículo salvo!", "success");
                vehicleForm.reset();
            } catch (error) {
                showMessage(messageAreaVehicle, "Erro ao salvar.", "error");
                console.error(error);
            }
        });

        // --- Trip Logic ---
        const loadTrips = () => {
            if (!userId) return;
            const tripsCollection = collection(db, `/artifacts/${appId}/users/${userId}/trips`);
            onSnapshot(query(tripsCollection), (snapshot) => {
                loadingStateTrip.style.display = 'none';
                tripHistoryBody.innerHTML = '';
                const trips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                trips.sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());

                if (trips.length === 0) {
                    tripHistoryBody.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-slate-500">Nenhum deslocamento.</td></tr>`;
                } else {
                    trips.forEach(trip => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-slate-50';
                        row.innerHTML = `
                            <td class="p-3 text-sm">${formatDate(trip.createdAt)}</td>
                            <td class="p-3">${trip.reason}</td>
                            <td class="p-3 text-right">${trip.totalKm.toFixed(2)} km</td>
                            <td class="p-3 text-right font-semibold text-green-600">${formatCurrency(trip.reimbursementValue)}</td>
                        `;
                        tripHistoryBody.appendChild(row);
                    });
                }
            });
        };

        const updateSummary = () => {
            const start = parseFloat(startKmInput.value) || 0;
            const end = parseFloat(endKmInput.value) || 0;
            const rate = parseFloat(rateInput.value) || 0;
            if (end > start) {
                const totalKm = end - start;
                const totalValue = totalKm * rate;
                totalKmSpan.textContent = `${totalKm.toFixed(2)} km`;
                totalValueSpan.textContent = formatCurrency(totalValue);
                summaryDiv.classList.remove('hidden');
            } else {
                summaryDiv.classList.add('hidden');
            }
        };

        [startKmInput, endKmInput, rateInput].forEach(input => input.addEventListener('input', updateSummary));
        startPhotoButton.addEventListener('click', () => startPhotoInput.click());
        endPhotoButton.addEventListener('click', () => endPhotoInput.click());
        startPhotoInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                startPhotoPreview.src = URL.createObjectURL(file);
                startPhotoPreview.classList.remove('hidden');
                startPhotoBase64 = await toBase64(file);
            }
        });
        endPhotoInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                endPhotoPreview.src = URL.createObjectURL(file);
                endPhotoPreview.classList.remove('hidden');
                endPhotoBase64 = await toBase64(file);
            }
        });
        tripForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return;
            if (endKmInput.value <= startKmInput.value) {
                showMessage(messageAreaTrip, "KM de chegada deve ser maior.", "error");
                return;
            }
            try {
                const tripsCollection = collection(db, `/artifacts/${appId}/users/${userId}/trips`);
                await addDoc(tripsCollection, {
                    vehicleId: tripForm.tripVehicle.value,
                    reason: tripForm.reason.value,
                    startKm: parseFloat(tripForm.startKm.value),
                    endKm: parseFloat(tripForm.endKm.value),
                    rate: parseFloat(tripForm.rate.value),
                    totalKm: parseFloat(endKmInput.value) - parseFloat(startKmInput.value),
                    reimbursementValue: (parseFloat(endKmInput.value) - parseFloat(startKmInput.value)) * parseFloat(rateInput.value),
                    startPhotoBase64,
                    endPhotoBase64,
                    createdAt: Timestamp.now(),
                });
                showMessage(messageAreaTrip, "Deslocamento salvo!", "success");
                tripForm.reset();
                summaryDiv.classList.add('hidden');
                startPhotoPreview.classList.add('hidden'); endPhotoPreview.classList.add('hidden');
                startPhotoBase64 = null; endPhotoBase64 = null;
            } catch (error) {
                showMessage(messageAreaTrip, "Erro ao salvar.", "error");
                console.error(error);
            }
        });

        // --- Fueling & Consumption Logic ---
        const loadFuelings = () => {
            if (!userId) return;
            const fuelingsCollection = collection(db, `/artifacts/${appId}/users/${userId}/fuelings`);
            onSnapshot(query(fuelingsCollection), (snapshot) => {
                loadingStateFueling.style.display = 'none';
                fuelingHistoryBody.innerHTML = '';
                const fuelings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Group by vehicle
                const fuelingsByVehicle = fuelings.reduce((acc, f) => {
                    if (!acc[f.vehicleId]) acc[f.vehicleId] = [];
                    acc[f.vehicleId].push(f);
                    return acc;
                }, {});

                let allFuelingsWithConsumption = [];
                let consumptionSummary = {};

                for (const vehicleId in fuelingsByVehicle) {
                    const vehicleFuelings = fuelingsByVehicle[vehicleId].sort((a, b) => a.odometer - b.odometer);
                    let totalKm = 0;
                    let totalLiters = 0;

                    for (let i = 0; i < vehicleFuelings.length; i++) {
                        const current = vehicleFuelings[i];
                        current.consumption = null;
                        if (i > 0) {
                            const previous = vehicleFuelings[i-1];
                            const kmTraveled = current.odometer - previous.odometer;
                            const litersUsed = previous.liters; // Consumption of the previous tank
                             if (kmTraveled > 0 && litersUsed > 0) {
                                current.consumption = kmTraveled / litersUsed;
                                totalKm += kmTraveled;
                                totalLiters += litersUsed;
                            }
                        }
                        allFuelingsWithConsumption.push(current);
                    }
                    if (totalLiters > 0) {
                        consumptionSummary[vehicleId] = {
                            avgConsumption: totalKm / totalLiters,
                            vehicleName: vehiclesCache.find(v => v.id === vehicleId)?.name || 'Desconhecido'
                        };
                    }
                }
                
                // Render summary
                consumptionSummaryDiv.innerHTML = '';
                if(Object.keys(consumptionSummary).length > 0) {
                    let summaryHTML = '<h3 class="font-bold mb-2">Média de Consumo Geral</h3>';
                    summaryHTML += '<div class="grid grid-cols-2 gap-4">';
                    for(const vehicleId in consumptionSummary) {
                        const data = consumptionSummary[vehicleId];
                        summaryHTML += `
                        <div class="bg-slate-50 p-3 rounded-lg">
                            <p class="text-sm text-slate-600">${data.vehicleName}</p>
                            <p class="font-bold text-lg text-blue-700">${data.avgConsumption.toFixed(2)} km/L</p>
                        </div>
                        `;
                    }
                    summaryHTML += '</div>';
                    consumptionSummaryDiv.innerHTML = summaryHTML;
                }

                // Render history table
                allFuelingsWithConsumption.sort((a, b) => b.date.toMillis() - a.date.toMillis());
                if(allFuelingsWithConsumption.length === 0) {
                    fuelingHistoryBody.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-slate-500">Nenhum abastecimento.</td></tr>`;
                } else {
                    allFuelingsWithConsumption.forEach(f => {
                        const row = document.createElement('tr');
                        const vehicleName = vehiclesCache.find(v => v.id === f.vehicleId)?.name || '...';
                        row.innerHTML = `
                            <td class="p-3 text-sm">${formatDate(f.date)}</td>
                            <td class="p-3">${vehicleName}</td>
                            <td class="p-3 text-right">${f.liters.toFixed(2)} L</td>
                            <td class="p-3 text-right font-semibold ${f.consumption ? 'text-blue-600' : 'text-slate-400'}">
                                ${f.consumption ? `${f.consumption.toFixed(2)} km/L` : '-'}
                            </td>
                        `;
                        fuelingHistoryBody.appendChild(row);
                    });
                }
            });
        };
        
        fuelingForm.addEventListener('submit', async (e) => {
             e.preventDefault();
            if(!userId) return;
            try {
                const fuelingsCollection = collection(db, `/artifacts/${appId}/users/${userId}/fuelings`);
                 await addDoc(fuelingsCollection, {
                    vehicleId: fuelingForm.fuelingVehicle.value,
                    date: Timestamp.fromDate(new Date(fuelingForm.fuelingDate.value + 'T12:00:00')), // Avoid timezone issues
                    odometer: parseFloat(fuelingForm.fuelingOdometer.value),
                    liters: parseFloat(fuelingForm.fuelingLiters.value),
                    cost: parseFloat(fuelingForm.fuelingCost.value)
                });
                showMessage(messageAreaFueling, "Abastecimento salvo!", "success");
                fuelingForm.reset();
            } catch (error) {
                showMessage(messageAreaFueling, "Erro ao salvar.", "error");
                console.error(error);
            }
        });


        // --- Report Modal Logic ---
        openReportModalBtn.addEventListener('click', () => {
            reportModal.classList.add('active');
            setTimeout(() => { reportModal.querySelector('div').classList.remove('scale-95', 'opacity-0'); }, 10);
        });
        const closeModal = () => {
             reportModal.querySelector('div').classList.add('scale-95', 'opacity-0');
             setTimeout(() => { reportModal.classList.remove('active'); }, 300);
        }
        closeReportModalBtn.addEventListener('click', closeModal);
        reportModal.addEventListener('click', (e) => { if(e.target === reportModal) closeModal(); });

        generateReportBtn.addEventListener('click', async () => {
             if (!userId) return;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!startDate || !endDate) {
                reportResultsDiv.innerHTML = `<p class="text-red-500">Selecione as datas.</p>`;
                return;
            }
            const startTimestamp = Timestamp.fromDate(new Date(startDate + 'T00:00:00'));
            const endTimestamp = Timestamp.fromDate(new Date(endDate + 'T23:59:59'));
            reportResultsDiv.innerHTML = `<p class="text-slate-500">Gerando...</p>`;

            try {
                const tripsCollection = collection(db, `/artifacts/${appId}/users/${userId}/trips`);
                const q = query(tripsCollection, where("createdAt", ">=", startTimestamp), where("createdAt", "<=", endTimestamp));
                const querySnapshot = await getDocs(q);
                let totalKmReport = 0, totalValueReport = 0, reportHTML = '';

                if (querySnapshot.empty) {
                     reportResultsDiv.innerHTML = `<p class="text-center p-4 bg-slate-50 rounded-lg">Nenhum registro no período.</p>`;
                     return;
                }
                const reportItems = [];
                querySnapshot.forEach((doc) => {
                    const trip = doc.data();
                    reportItems.push(trip);
                    totalKmReport += trip.totalKm;
                    totalValueReport += trip.reimbursementValue;
                });
                
                reportItems.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());

                reportHTML += `<ul class="divide-y divide-slate-200 max-h-60 overflow-y-auto pr-2">`;
                reportItems.forEach(trip => {
                    reportHTML += `<li class="py-3"><div class="flex justify-between items-center text-sm"><div><p class="font-semibold">${trip.reason}</p><p class="text-slate-500">${formatDate(trip.createdAt)}</p></div><div class="text-right"><p class="font-medium text-green-600">${formatCurrency(trip.reimbursementValue)}</p><p class="text-slate-500">${trip.totalKm.toFixed(2)} km</p></div></div></li>`;
                });
                 reportHTML += `</ul>`;
                 reportHTML += `<div class="mt-6 pt-4 border-t border-slate-200 bg-slate-50 p-4 rounded-lg"><h4 class="font-bold text-lg mb-2">Resumo do Período</h4><div class="flex justify-between items-center"><span class="text-slate-600">Distância Total:</span><span class="font-bold text-slate-800">${totalKmReport.toFixed(2)} km</span></div><div class="flex justify-between items-center mt-1"><span class="text-slate-600">Reembolso Total:</span><span class="font-bold text-green-700 text-xl">${formatCurrency(totalValueReport)}</span></div></div>`;
                reportResultsDiv.innerHTML = reportHTML;
            } catch (error) {
                console.error("Error generating report: ", error);
                reportResultsDiv.innerHTML = `<p class="text-red-500">Erro ao gerar o relatório.</p>`;
            }
        });

    </script>
</body>
</html>
